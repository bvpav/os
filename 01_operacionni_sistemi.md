# Операционни системи

## Видове софтуер

| Компонент (`.c` &rarr; `.o`)     | Интерфейс                                            | Функции                                                 |
| -------------------------------- | ---------------------------------------------------- | ------------------------------------------------------- |
| Бизнес модул                     | Към потребителя, ч/з конзола, графична система и др. | Бизнес функции: напр. текстообработка                   |
| Библиотеки за общи проблеми      | Максимално опростен                                  | Математически низове, разпределение на паметта (`libc`) |
| Библиотеки за достъп до хардуера | Представя абстрактно устройство                      | Управлява конкретен хардуер                             |

## Какво е ОС?

- Софтуер, даващ възможност за споделяне на ресурсите на хардуера между различни програми
- Тези програми са агентите, за които се грижи ОС, така че всяка програма да не се съобразява с останалите, а само с ОС
- Споделянето на ресурсите бива чрез изолация (заключване), или чрез заявки
- При изолацията ОС показва даден ресурс _само и единствено на неговия собственик_
- При заявките всички програми генерират заявки към един и същ ресурс едновременно

## Споделяне на ресурси чрез заявки

- Споделянето на ресурси чрез заявки бива последователно (блокиращо) и паралелно (асинхронно)
- При блокиращото споделяне приложението се блокира за да изчака завършека на предната операция по дадения ресурс
<!-- ПОМОЩ, НЕ ГО ЗАПИСАХ: -->
- При асинхронното споделяне приложението изпраща заявка към устройството, която отива в опашка и се изпълнява в паралел на продължаващото приложение
- Опашката може да се намира ... или ...

## Ресурси на хардуера

- Процесори
- RAM памет (DDR4)
- Блокова памет (SSD, HDD, M.2)
- Мрежов адаптер
  - Принтер
  - Скенер
- Сериен интерфейс
  - Клавиатура
  - Мишка
- Видео адаптер

## Техники за споделяне

| Хардуер          | Абстракция към програмата      | Споделяне ч/з                                   |
| ---------------- | ------------------------------ | ----------------------------------------------- |
| Процесор         | Множество нишки                | Времеделене+изолация                            |
| Памет            | Виртуално адресно пространство | Изолация                                        |
| Диск             | Файлове система                | Заявки                                          |
| Мрежа            | Сокети                         | Заявки                                          |
| Сериен интерфейс | Крайни устройства (endpoints)  | заявки                                          |
| Принтер          | Логически принтер              | Асинхронни заявки, буферирани на диска (спулер) |
| Видеокарта       | Повърхности (surfaces)         | изолация                                        |

## Видове реална памет

- Физическото адресното пространство е достъпно на процесора при изключено стартиране <!-- страниране?? -->
- Контролера на паметта може да поставя (мапва) памет от външните устройства на адреси във физическото адресно пространство

| Източник          | Връзка          | Особености    | Достъп                                 |
| ----------------- | --------------- | ------------- | -------------------------------------- |
| RAM               | Директна        | Малка, бърза  | Чрез адресното пространство            |
| Блокова           | PCIe, SATA, M.2 | Голяма, бавна | Заявки чрез регистър, DMA, прекъсвания |
| Външни устройства | PCIe            | Средна        | Чрез адресното пространство            |

## Виртуална памет

- Поддържа се от страниращата (paging) система на процесора
- Транслира виртуални във физически адреси с числово дърво
- За всеки процес се създава отделно адресно пространство
- Състои се от 2 части - потребителско адресно пространство и системно АП, в което са мапнати всички обекти на ядрото
- Системното АП е достъпно само в привилегирован режи на процесора и е общо за всички процеси
- Потребителското АП е достъпно само от дадения процес, основен за споделени области

> Колко бита трябва да е логическото адресно пространство? ~ доста

## Резервиране на адресно пространство

- Резервирането на АП е отделено от заделянето на памет
- Блоковете на обвързване трябва да се съдържат в блок на резервация
- Не е нужно да са последователни
- Linux и macOS използват POSIX API

| ОС      | Заделяне адресно пространство                   | Обвързване АП с памет        |
| ------- | ----------------------------------------------- | ---------------------------- |
| POSIX   | `p=mmap(PROT_NONE, MAP_PRIVATE\|MAP_ANONYOMUS)` | `mprotect(p,PROT_WRITE)`     |
| Windows | `p=VirtualAlloc(MEM_RESERVE)`                   | `VirtualAlloc(p,MEM_COMMIT)` |

### Примерен код:

- [POSIX](./adresno_prostranstvo/posix/mem.c)
- Win32 (TODO...)

### Документация:

#### **`mmap()`:**

- [mmap(3p)](https://man7.org/linux/man-pages/man3/mmap.3p.html) - _POSIX Programmer's Manual_
- [mmap(2)](https://man7.org/linux/man-pages/man2/mmap.2.html) - _Linux Syscalls Manual_
- [mmap(2)](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/mmap.2.html) - _Mac OS X, BSD System Calls Manual_

#### **`mprotect()`:**

- [mprotect(3p)](https://man7.org/linux/man-pages/man3/mprotect.3p.html) - _POSIX Programmer's Manual_
- [mprotect(2)](https://man7.org/linux/man-pages/man2/mprotect.2.html) - _Linux Syscalls Manual_
- [mprotect(2)](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/mprotect.2.html) - _Mac OS X, BSD System Calls Manual_

#### **`VirtualAlloc()`:**

- [VirtualAlloc function (memoryapi.h)](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) - _Win32 API reference documentation_
